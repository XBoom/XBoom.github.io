<!DOCTYPE html>
<html lang=en>
<head>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?35ec0b872cf5aada9525fd9f0487c238";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Grpc-03-帧 | Yuan Kang</title>
  <meta name="description" content="从前面可知，流单独负责一次调用，并且在服务端使用多路复用实现消息的处理。流其实是通过 ID 标志的虚拟概念，真正传输的其实是帧，帧通过发送器与帧接收器进行发送处理。 带着问题看世界：  帧的类型有哪些，具体结构是怎样的 当消息体过大的时候分帧是如何处理的 当帧的缓冲区是否也会满，什么时候清理  在 grpc-go 中，通过对 HTTP&#x2F;2 中协议的封装，增加了grpc-go自己的业务类型。看源码的">
<meta property="og:type" content="article">
<meta property="og:title" content="Grpc-03-帧">
<meta property="og:url" content="http://xboom.github.io/2022/10/11/Grpc/Grpc-05-%E5%B8%A7/index.html">
<meta property="og:site_name" content="XBoom Dove">
<meta property="og:description" content="从前面可知，流单独负责一次调用，并且在服务端使用多路复用实现消息的处理。流其实是通过 ID 标志的虚拟概念，真正传输的其实是帧，帧通过发送器与帧接收器进行发送处理。 带着问题看世界：  帧的类型有哪些，具体结构是怎样的 当消息体过大的时候分帧是如何处理的 当帧的缓冲区是否也会满，什么时候清理  在 grpc-go 中，通过对 HTTP&#x2F;2 中协议的封装，增加了grpc-go自己的业务类型。看源码的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images-1307117474.cos.ap-guangzhou.myqcloud.com/blogs/Blog_3/http2_dataframe.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f3f3f45e713842cdb0162ae119b6045f.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTE1ODI5MjI=,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://images-1307117474.cos.ap-guangzhou.myqcloud.com/blogs/Blog_3/http2_dataframe2.png">
<meta property="article:published_time" content="2022-10-11T14:58:29.000Z">
<meta property="article:modified_time" content="2023-05-27T10:55:06.561Z">
<meta property="article:author" content="XBoom Dove">
<meta property="article:tag" content="Grpc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images-1307117474.cos.ap-guangzhou.myqcloud.com/blogs/Blog_3/http2_dataframe.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://xboom.github.io/2022/10/11/Grpc/Grpc-05-%E5%B8%A7/index.html">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="XBoom Dove" type="application/atom+xml">
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/XBoom" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Yuan Kang</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Learn and live</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/XBoom" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=728081687@qq.com" target="_blank" title="Email" data-toggle=tooltip data-placement=top><i class="icon icon-email"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>Keep on going never give up!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithms/">Algorithms</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithms-To-Live-By/">Algorithms To Live By</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Patterns/">Design Patterns</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Transaction/">Distributed Transaction</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Grpc/">Grpc</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Interesting-Algorithm/">Interesting Algorithm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Microservices/">Microservices</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySql/">MySql</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Protocol/">Protocol</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/" rel="tag">Algorithm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithms/" rel="tag">Algorithms</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithms-To-Live-By/" rel="tag">Algorithms To Live By</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Concurrency/" rel="tag">Concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DHCP/" rel="tag">DHCP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Structure/" rel="tag">Data Structure</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Patterns/" rel="tag">Design Patterns</a><span class="tag-list-count">25</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed-System/" rel="tag">Distributed System</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed-Transaction/" rel="tag">Distributed Transaction</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ETCD/" rel="tag">ETCD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Grpc/" rel="tag">Grpc</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/" rel="tag">Heap</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Libevent/" rel="tag">Libevent</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/List/" rel="tag">List</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memory/" rel="tag">Memory</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microservices/" rel="tag">Microservices</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySql/" rel="tag">MySql</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PrimerPlus/" rel="tag">PrimerPlus</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protocol/" rel="tag">Protocol</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Quic/" rel="tag">Quic</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raft/" rel="tag">Raft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP-IP/" rel="tag">TCP/IP</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 13.08px;">Algorithm</a> <a href="/tags/Algorithms/" style="font-size: 13.15px;">Algorithms</a> <a href="/tags/Algorithms-To-Live-By/" style="font-size: 13.38px;">Algorithms To Live By</a> <a href="/tags/C/" style="font-size: 13.85px;">C++</a> <a href="/tags/Concurrency/" style="font-size: 13px;">Concurrency</a> <a href="/tags/DHCP/" style="font-size: 13px;">DHCP</a> <a href="/tags/Data-Structure/" style="font-size: 13.08px;">Data Structure</a> <a href="/tags/Design-Patterns/" style="font-size: 13.92px;">Design Patterns</a> <a href="/tags/Distributed-System/" style="font-size: 13px;">Distributed System</a> <a href="/tags/Distributed-Transaction/" style="font-size: 13.46px;">Distributed Transaction</a> <a href="/tags/Docker/" style="font-size: 13px;">Docker</a> <a href="/tags/ETCD/" style="font-size: 13px;">ETCD</a> <a href="/tags/Go/" style="font-size: 14px;">Go</a> <a href="/tags/Grpc/" style="font-size: 13.69px;">Grpc</a> <a href="/tags/HTTP/" style="font-size: 13px;">HTTP</a> <a href="/tags/Heap/" style="font-size: 13.08px;">Heap</a> <a href="/tags/Kafka/" style="font-size: 13.23px;">Kafka</a> <a href="/tags/Libevent/" style="font-size: 13.08px;">Libevent</a> <a href="/tags/Linux/" style="font-size: 13.23px;">Linux</a> <a href="/tags/List/" style="font-size: 13px;">List</a> <a href="/tags/MQ/" style="font-size: 13.31px;">MQ</a> <a href="/tags/Memory/" style="font-size: 13px;">Memory</a> <a href="/tags/Microservices/" style="font-size: 13.62px;">Microservices</a> <a href="/tags/MySql/" style="font-size: 13.54px;">MySql</a> <a href="/tags/PrimerPlus/" style="font-size: 13.77px;">PrimerPlus</a> <a href="/tags/Protocol/" style="font-size: 13px;">Protocol</a> <a href="/tags/Quic/" style="font-size: 13px;">Quic</a> <a href="/tags/Raft/" style="font-size: 13px;">Raft</a> <a href="/tags/Redis/" style="font-size: 13.69px;">Redis</a> <a href="/tags/TCP-IP/" style="font-size: 13.31px;">TCP/IP</a> <a href="/tags/k8s/" style="font-size: 13.31px;">k8s</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Data-Structure/">Data Structure</a>
              </p>
              <p class="item-title">
                <a href="/2023/09/29/Data%20Structure/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-02-Heap/" class="title">数据结构-02-Heap</a>
              </p>
              <p class="item-date">
                <time datetime="2023-09-28T16:16:00.000Z" itemprop="datePublished">2023-09-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Algorithms/">Algorithms</a>
              </p>
              <p class="item-title">
                <a href="/2023/09/29/Algorithm/%E7%AE%97%E6%B3%95-01-Heap/" class="title">算法-01-Heap</a>
              </p>
              <p class="item-date">
                <time datetime="2023-09-28T16:15:00.000Z" itemprop="datePublished">2023-09-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Data-Structure/">Data Structure</a>
              </p>
              <p class="item-title">
                <a href="/2023/09/18/Data%20Structure/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-01-List/" class="title">数据结构-01-List</a>
              </p>
              <p class="item-date">
                <time datetime="2023-09-18T14:58:29.000Z" itemprop="datePublished">2023-09-18</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Protocol/">Protocol</a>
              </p>
              <p class="item-title">
                <a href="/2023/09/07/Protocol/Protocol-04-DHCP/" class="title">Protocol-04-DHCP</a>
              </p>
              <p class="item-date">
                <time datetime="2023-09-07T02:25:38.000Z" itemprop="datePublished">2023-09-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Go/">Go</a>
              </p>
              <p class="item-title">
                <a href="/2023/07/15/Go/Go-27-SyncPool/" class="title">Go-27-SyncPool</a>
              </p>
              <p class="item-date">
                <time datetime="2023-07-15T05:32:45.000Z" itemprop="datePublished">2023-07-15</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">Catalogue</h3>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#协议帧"><span class="toc-number">1.</span> <span class="toc-text"> 协议帧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#头部"><span class="toc-number">1.1.</span> <span class="toc-text"> 头部</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#帧的类型"><span class="toc-number">1.2.</span> <span class="toc-text"> 帧的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#帧的标志位"><span class="toc-number">1.3.</span> <span class="toc-text"> 帧的标志位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#负载"><span class="toc-number">1.4.</span> <span class="toc-text"> 负载</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#framedata"><span class="toc-number">1.4.1.</span> <span class="toc-text"> FrameData</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#frameheaders"><span class="toc-number">1.4.2.</span> <span class="toc-text"> FrameHeaders</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framepriority"><span class="toc-number">1.4.3.</span> <span class="toc-text"> FramePriority</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framerststream"><span class="toc-number">1.4.4.</span> <span class="toc-text"> FrameRSTStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framesettings"><span class="toc-number">1.4.5.</span> <span class="toc-text"> FrameSettings</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framepushpromise"><span class="toc-number">1.4.6.</span> <span class="toc-text"> FramePushPromise</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#frameping"><span class="toc-number">1.4.7.</span> <span class="toc-text"> FramePing</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framegoaway"><span class="toc-number">1.4.8.</span> <span class="toc-text"> FrameGoAway</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framewindowupdate"><span class="toc-number">1.4.9.</span> <span class="toc-text"> FrameWindowUpdate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#framecontinuation"><span class="toc-number">1.4.10.</span> <span class="toc-text"> FrameContinuation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用帧"><span class="toc-number">2.</span> <span class="toc-text"> 应用帧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分帧"><span class="toc-number">3.</span> <span class="toc-text"> 分帧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端"><span class="toc-number">3.1.</span> <span class="toc-text"> 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端"><span class="toc-number">3.2.</span> <span class="toc-text"> 服务端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text"> 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文档"><span class="toc-number">5.</span> <span class="toc-text"> 参考文档</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Grpc/Grpc-05-帧" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Grpc-03-帧
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/10/11/Grpc/Grpc-05-%E5%B8%A7/" class="article-date">
	  <time datetime="2022-10-11T14:58:29.000Z" itemprop="datePublished">2022-10-11</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Grpc/">Grpc</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Grpc/" rel="tag">Grpc</a>
  </span>


        

	<span class="article-read hidden-xs">
    	<i class="icon icon-eye-fill" aria-hidden="true"></i>
    	<span id="/2022/10/11/Grpc/Grpc-05-%E5%B8%A7/" class="leancloud_visitors"  data-flag-title="Grpc-03-帧">0</span>
    </span>

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/10/11/Grpc/Grpc-05-%E5%B8%A7/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>从前面可知，流单独负责一次调用，并且在服务端使用多路复用实现消息的处理。流其实是通过 ID 标志的虚拟概念，真正传输的其实是帧，帧通过发送器与帧接收器进行发送处理。</p>
<p>带着问题看世界：</p>
<ol>
<li>帧的类型有哪些，具体结构是怎样的</li>
<li>当消息体过大的时候分帧是如何处理的</li>
<li>当帧的缓冲区是否也会满，什么时候清理</li>
</ol>
<p>在 grpc-go 中，通过对 HTTP/2 中协议的封装，增加了<code>grpc-go</code>自己的业务类型。看源码的时候注意不要弄混了。这里说的协议帧 是 HTTP/2 中定义实际传输过程中的帧 是由 net 库实现的；而应用帧则是 <code>grpc-go</code> 根据自己的实际需要由转换了一层</p>
<h3 id="协议帧"><a class="markdownIt-Anchor" href="#协议帧"></a> 协议帧</h3>
<p>每个协议帧都是由<strong>头部</strong>与<strong>负载</strong>两个部分组成</p>
<h4 id="头部"><a class="markdownIt-Anchor" href="#头部"></a> 头部</h4>
<p>协议帧指的就是HTTP2中帧的结构，每个帧也分为头部与负载</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+--------+--------+--------+--------+</span><br><span class="line">|        Length(<span class="number">24</span>)        |Type(<span class="number">8</span>) |Flags(<span class="number">8</span>)|R|       StreamID(<span class="number">31</span>)     |</span><br><span class="line">+--------+--------+--------+--------+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure>
<blockquote>
<p>虽然Length 是24位，但这不意味着就能处理 2^24 16M大小的帧，一般是默认只支持2^16 16k以下的帧，而2^16 - 2^24 16M 的帧 需要接收端公布自己可以处理这么大的帧，需要在 <strong>SETTINGS_MAX_FRAME_SIZE</strong> 帧中告知</p>
</blockquote>
<p>将二进制buffer转换为帧头部结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FrameHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">	valid <span class="keyword">bool</span> 			<span class="comment">// 是否有效，供内部使用</span></span><br><span class="line">	Type FrameType		<span class="comment">// 帧的类型</span></span><br><span class="line">	Flags Flags			<span class="comment">// 标志位</span></span><br><span class="line">	Length <span class="keyword">uint32</span>		<span class="comment">// 帧的负载长度(即不包括头部)</span></span><br><span class="line">	StreamID <span class="keyword">uint32</span>		<span class="comment">// 流ID，有的帧没有流，那么StreamID == 0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以头部的整体解析流程就变成了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFrameHeader</span><span class="params">(buf []<span class="keyword">byte</span>, r io.Reader)</span> <span class="params">(FrameHeader, error)</span></span> &#123;</span><br><span class="line">   _, err := io.ReadFull(r, buf[:frameHeaderLen])	<span class="comment">//读取9B到buf中</span></span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> FrameHeader&#123;&#125;, err</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> FrameHeader&#123;	<span class="comment">//解析成头部接头</span></span><br><span class="line">      Length:   (<span class="keyword">uint32</span>(buf[<span class="number">0</span>])&lt;&lt;<span class="number">16</span> | <span class="keyword">uint32</span>(buf[<span class="number">1</span>])&lt;&lt;<span class="number">8</span> | <span class="keyword">uint32</span>(buf[<span class="number">2</span>])),	<span class="comment">//头部长度 </span></span><br><span class="line">      Type:     FrameType(buf[<span class="number">3</span>]),	<span class="comment">//类型	</span></span><br><span class="line">      Flags:    Flags(buf[<span class="number">4</span>]),			<span class="comment">//标志位</span></span><br><span class="line">      StreamID: binary.BigEndian.Uint32(buf[<span class="number">5</span>:]) &amp; (<span class="number">1</span>&lt;&lt;<span class="number">31</span> - <span class="number">1</span>),	</span><br><span class="line">      valid:    <span class="literal">true</span>,	<span class="comment">//是否有效</span></span><br><span class="line">   &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值得注意的是：</p>
<ol>
<li><code>binary.BigEndian.Uint32</code> 这个作用是将 4个字节的二进制数据转换为 uint32类型的数据</li>
<li><code>1&lt;&lt;31 - 1</code> 用于将高位设置为0，确保能被正确的解析为uint32位的值</li>
</ol>
<p>最后数据帧的格式如下</p>
<p><img src="https://images-1307117474.cos.ap-guangzhou.myqcloud.com/blogs/Blog_3/http2_dataframe.png" alt="" /></p>
<h4 id="帧的类型"><a class="markdownIt-Anchor" href="#帧的类型"></a> 帧的类型</h4>
<p>其中 <code>FrameType</code> 代表的帧类型，一共有10中</p>
<table>
<thead>
<tr>
<th>帧类型</th>
<th>说明</th>
<th>值</th>
<th>字符</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>FrameData</strong></td>
<td>表示数据帧，用于传输 HTTP 报文的实际数据部分</td>
<td>0x0</td>
<td>“DATA”</td>
</tr>
<tr>
<td><strong>FrameHeaders</strong></td>
<td>携带请求或响应头部，也可以分为多个帧进行传输</td>
<td>0x1</td>
<td>“HEADERS”</td>
</tr>
<tr>
<td><strong>FramePriority</strong></td>
<td>表示某个流的优先级，用于流量控制</td>
<td>0x2</td>
<td>“PRIORITY”</td>
</tr>
<tr>
<td><strong>FrameRSTStream</strong></td>
<td>重置某个流，表示这个流将不再使用</td>
<td>0x3</td>
<td>“RST_STREAM”</td>
</tr>
<tr>
<td><strong>FrameSettings</strong></td>
<td>表示设置帧，用于在连接和流级别上传输参数设置</td>
<td>0x4</td>
<td>“SETTINGS”</td>
</tr>
<tr>
<td><strong>FramePushPromise</strong></td>
<td>允许服务端在客户端还没有请求的情况下发送响应头部，用于服务端推送(server push)功能</td>
<td>0x5</td>
<td>“PUSH_PROMISE”</td>
</tr>
<tr>
<td><strong>FramePing</strong></td>
<td>表示 Ping 帧，用于检测连接是否存活</td>
<td>0x6</td>
<td>“PING”</td>
</tr>
<tr>
<td><strong>FrameGoAway</strong></td>
<td>表示断开帧，用于通知对端关闭连接</td>
<td>0x7</td>
<td>“GOAWAY”</td>
</tr>
<tr>
<td><strong>FrameWindowUpdate</strong></td>
<td>用于流量控制，通知对端窗口大小的变化</td>
<td>0x8</td>
<td>“WINDOW_UPDATE”</td>
</tr>
<tr>
<td><strong>FrameContinuation</strong></td>
<td>表示继续帧，将头部帧或推送帧拆分为多个帧进行传输时，用于指示后续帧属于同一个头部块</td>
<td>0x9</td>
<td>“CONTINUATION”</td>
</tr>
</tbody>
</table>
<h4 id="帧的标志位"><a class="markdownIt-Anchor" href="#帧的标志位"></a> 帧的标志位</h4>
<p>另外一个标志位Flags则是帧</p>
<table>
<thead>
<tr>
<th>帧类型</th>
<th>Flags类型</th>
<th>说明</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>FrameData</strong></td>
<td>FlagDataEndStream</td>
<td>标志位用于 <code>DATA</code> 帧，表示这是最后一个 <code>DATA</code> 帧，即流已经结束，接收方不应该再等待更多的 <code>DATA</code> 帧</td>
<td>0x1</td>
</tr>
<tr>
<td></td>
<td>FlagDataPadded</td>
<td>数据帧的填充(Padded)标志，表示数据帧后面跟随一个填充字段</td>
<td>0x8</td>
</tr>
<tr>
<td><strong>FrameHeaders</strong></td>
<td>FlagHeadersEndStream</td>
<td>首部帧(Headers Frame)的结束流标志，表示发送方已经发送完整个消息</td>
<td>0x1</td>
</tr>
<tr>
<td></td>
<td>FlagHeadersEndHeaders</td>
<td>首部帧的结束头(End Headers)标志，表示这个首部块是消息的最后一个首部块</td>
<td>0x4</td>
</tr>
<tr>
<td></td>
<td>FlagHeadersPadded</td>
<td>首部帧的填充标志，表示首部帧后面跟随一个填充字段</td>
<td>0x8</td>
</tr>
<tr>
<td></td>
<td>FlagHeadersPriority</td>
<td>首部帧的优先级(Priority)标志，表示这个首部块包含了一个优先级信息</td>
<td>0x20</td>
</tr>
<tr>
<td><strong>FrameSettings</strong></td>
<td>FlagSettingsAck</td>
<td>设置帧(Settings Frame)的确认(Ack)标志，表示这是一个确认帧</td>
<td>0x1</td>
</tr>
<tr>
<td><strong>FramePing</strong></td>
<td>FlagPingAck</td>
<td>Ping帧的确认标志，表示这是一个确认帧</td>
<td>0x1</td>
</tr>
<tr>
<td><strong>FrameContinuation</strong></td>
<td>FlagContinuationEndHeaders</td>
<td>连续帧(Continuation Frame)的结束头标志，表示这个连续块是消息的最后一个连续块</td>
<td>0x4</td>
</tr>
<tr>
<td><strong>FramePushPromise</strong></td>
<td>FlagPushPromiseEndHeaders</td>
<td>推送帧(Push Promise Frame)的结束头标志，表示这个推送帧包含了一个完整的首部块</td>
<td>0x4</td>
</tr>
<tr>
<td></td>
<td>FlagPushPromisePadded</td>
<td>推送帧的填充标志，表示推送帧后面跟随一个填充字段</td>
<td>0x8</td>
</tr>
</tbody>
</table>
<p>有了上述的帧的关键字段说明，接下来来看看各个数据帧的解析</p>
<h4 id="负载"><a class="markdownIt-Anchor" href="#负载"></a> 负载</h4>
<p>头部定义之后，负载通过头部长度 <strong>Length</strong> 进行解析，负载解析如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload := fr.getReadBuf(fh.Length)	<span class="comment">//获取负载长度</span></span><br><span class="line"><span class="keyword">if</span> _, err := io.ReadFull(fr.r, payload); err != <span class="literal">nil</span> &#123;	<span class="comment">//读取负载长度</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">f, err := typeFrameParser(fh.Type)(fr.frameCache, fh, payload)	<span class="comment">//将负载根据类型解析为对应的帧 fh是上一步读取的帧头</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> ce, ok := err.(connError); ok &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, fr.connError(ce.Code, ce.Reason)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据帧的解析是通过类型参数进行解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f, err := typeFrameParser(fh.Type)(fr.frameCache, fh, payload)</span><br></pre></td></tr></table></figure>
<p>其中</p>
<ol>
<li><code>fh.Type</code> 是从头部解析出来的帧的类型，用于找到指定类型的数据帧解析器</li>
<li><code>fr.frameCache</code> 流都具有自己的帧内存缓存池。在需要发送帧时，可以从自己的缓存池中获取内存，并在完成后将其返回以供重用</li>
<li><code>fh</code> 之前解析出的帧的头部，用来与解析完的负载合并成一个完整的帧</li>
<li><code>payload</code> 则是帧的负载，用于解析帧的数据部分</li>
</ol>
<p>需要关注的是</p>
<ol>
<li>是如何转换成其他类型的</li>
<li>如果有存在分帧，又是如何进行解析的</li>
<li>如果有帧的丢失怎么办</li>
</ol>
<h5 id="framedata"><a class="markdownIt-Anchor" href="#framedata"></a> FrameData</h5>
<p>数据帧的解析对应的是 <code>parseDataFrame</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseDataFrame</span><span class="params">(fc *frameCache, fh FrameHeader, payload []<span class="keyword">byte</span>)</span> <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID == <span class="number">0</span> &#123;	<span class="comment">//数据帧StreamID必不为0</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, connError&#123;ErrCodeProtocol, <span class="string">"DATA frame with stream ID 0"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   f := fc.getDataFrame()	<span class="comment">//从内存池获取一个数据帧结构</span></span><br><span class="line">   f.FrameHeader = fh			<span class="comment">//帧头部</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> padSize <span class="keyword">byte</span></span><br><span class="line">   <span class="keyword">if</span> fh.Flags.Has(FlagDataPadded) &#123;	<span class="comment">//如果有追加</span></span><br><span class="line">      <span class="keyword">var</span> err error</span><br><span class="line">      payload, padSize, err = readByte(payload)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">int</span>(padSize) &gt; <span class="built_in">len</span>(payload) &#123;	<span class="comment">//当追加的长度大于负载的长度</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, connError&#123;ErrCodeProtocol, <span class="string">"pad size larger than data payload"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   f.data = payload[:<span class="built_in">len</span>(payload)-<span class="keyword">int</span>(padSize)]	<span class="comment">//帧的负载就是 负载 - 追加</span></span><br><span class="line">   <span class="keyword">return</span> f, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当存在追加帧 <code>FlagDataPadded</code> 的时候 使用 <code>readByte</code>进行解析出去除追加长度的负载</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readByte</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(remain []<span class="keyword">byte</span>, b <span class="keyword">byte</span>, err error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(p) == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, <span class="number">0</span>, io.ErrUnexpectedEOF</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> p[<span class="number">1</span>:], p[<span class="number">0</span>], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，正常情况只有负载，但是如果数据帧存在追加  <code>FlagDataPadded</code>，数据帧的负载还有一个长度</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             padSize(<span class="number">32</span>)						|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|							data	...							</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|							padding ...</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure>
<p><strong>追加的内容在解析成数据帧的过程中，丢掉了！！！！！</strong> 这是因为填充字段仅仅是为了将数据帧填充到规定的长度</p>
<p>最终组成数据帧</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DataFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   data []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么另外一个标志位 <code>FlagDataEndStream</code> 是在应用gRPC使用</p>
<ul>
<li>服务端收到数据帧结束流之后，设置流的状态并结束继续读取流数据</li>
<li>客户端收到数据帧结束流之后，关闭流(结束读取并清理流)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//客户端</span></span><br><span class="line"><span class="keyword">if</span> f.StreamEnded() &#123;</span><br><span class="line">		t.closeStream(s, io.EOF, <span class="literal">false</span>, http2.ErrCodeNo, status.New(codes.Internal, <span class="string">"server closed the stream without sending trailers"</span>), <span class="literal">nil</span>, <span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端</span></span><br><span class="line"><span class="keyword">if</span> f.StreamEnded() &#123;</span><br><span class="line">   <span class="comment">// Received the end of stream from the client.</span></span><br><span class="line">   s.compareAndSwapState(streamActive, streamReadDone)</span><br><span class="line">   s.write(recvMsg&#123;err: io.EOF&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他注意事项</p>
<ol>
<li>如果数据帧中 <code>StreamID == 0</code> ，那么这个数据帧异常，也就是说数据帧必须绑定一个流</li>
</ol>
<h5 id="frameheaders"><a class="markdownIt-Anchor" href="#frameheaders"></a> FrameHeaders</h5>
<p>头帧也是由头部与负载组成，通过 <code>parseHeadersFrame</code> 解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseHeadersFrame</span><span class="params">(_ *frameCache, fh FrameHeader, p []<span class="keyword">byte</span>)</span> <span class="params">(_ Frame, err error)</span></span> &#123;</span><br><span class="line">   hf := &amp;HeadersFrame&#123;</span><br><span class="line">      FrameHeader: fh,</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID == <span class="number">0</span> &#123;	<span class="comment">//头帧流ID不能为0</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, connError&#123;ErrCodeProtocol, <span class="string">"HEADERS frame with stream ID 0"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">var</span> padLength <span class="keyword">uint8</span></span><br><span class="line">   <span class="keyword">if</span> fh.Flags.Has(FlagHeadersPadded) &#123;	<span class="comment">//如果有头部追加，同理解析出负载与追加长度</span></span><br><span class="line">      <span class="keyword">if</span> p, padLength, err = readByte(p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> fh.Flags.Has(FlagHeadersPriority) &#123;	<span class="comment">//如果有优先级</span></span><br><span class="line">      <span class="keyword">var</span> v <span class="keyword">uint32</span></span><br><span class="line">      p, v, err = readUint32(p)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line">      hf.Priority.StreamDep = v &amp; <span class="number">0x7fffffff</span></span><br><span class="line">      hf.Priority.Exclusive = (v != hf.Priority.StreamDep) <span class="comment">// high bit was set</span></span><br><span class="line">      p, hf.Priority.Weight, err = readByte(p)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(p)-<span class="keyword">int</span>(padLength) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, streamError(fh.StreamID, ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   hf.headerFragBuf = p[:<span class="built_in">len</span>(p)-<span class="keyword">int</span>(padLength)]	<span class="comment">//去掉追加部分</span></span><br><span class="line">   <span class="keyword">return</span> hf, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整体来看，头帧结构如下所示</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             padSize(<span class="number">32</span>)						|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             priority(<span class="number">32</span>)					|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|weight(<span class="number">8</span>)|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             payload								|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|						padding									|</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure>
<p>这里比数据帧多的第一个标志位就是 优先级 <code>FlagHeadersPriority</code>，它的作用是表示流的优先级</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PriorityParam <span class="keyword">struct</span> &#123;</span><br><span class="line">   StreamDep <span class="keyword">uint32</span></span><br><span class="line">   Exclusive <span class="keyword">bool</span></span><br><span class="line">   Weight <span class="keyword">uint8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>StreamDep</code>：一个31位的流标识符，表示此流依赖的流。如果为0，表示没有依赖关系。</li>
<li><code>Exclusive</code>：表示此流是否具有互斥性。如果此字段为true，表示此流是在其依赖的流和同级的兄弟流之间互斥的。</li>
<li><code>Weight</code>：此流的权重值，是一个0-255的值。根据规范，应该将此字段与<code>StreamDep</code>一起设置，或者两者都不设置。为了获得1到256之间的权重，请将此值加1</li>
</ol>
<blockquote>
<p>为什么流有依赖关系或者互斥关系???</p>
<p>流之间的依赖关系或者互斥关系可以帮助控制流之间的优先级和竞争关系，从而更有效地利用网络带宽和资源。</p>
<p>例如1：如果一个网页需要加载多个资源，比如图片、脚本和样式表，那么这些资源就可以分别被分配到不同的流中。为了更快地呈现网页，图片这类占用带宽较大的资源可以被赋予更高的优先级，使其在竞争网络资源时更优先被传输，从而减少用户等待时间。</p>
<p>例如2：如果一个客户端同时向服务器发起了多个请求，这些请求可能会在服务器端形成竞争关系，造成某些请求的延迟和等待时间过长。通过为请求之间建立依赖关系和互斥关系，可以更好地控制请求的执行顺序和资源利用，提高服务质量和用户体验</p>
</blockquote>
<p>最后组成结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HeadersFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   Priority PriorityParam</span><br><span class="line">   headerFragBuf []<span class="keyword">byte</span> <span class="comment">// not owned</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外两个标志位 <code>FlagHeadersEndStream</code> 和 <code>FlagHeadersEndHeaders</code> 同理，是在应用层使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> fh.Type &#123;</span><br><span class="line"><span class="keyword">case</span> FrameHeaders, FrameContinuation:</span><br><span class="line">   <span class="keyword">if</span> fh.Flags.Has(FlagHeadersEndHeaders) &#123;</span><br><span class="line">      fr.lastHeaderStream = <span class="number">0</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fr.lastHeaderStream = fh.StreamID</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="framepriority"><a class="markdownIt-Anchor" href="#framepriority"></a> FramePriority</h5>
<p>虽然头帧中可以设置流的优先级，但是如果有大量的流需要设置优先级，将会导致头帧变得非常庞大，传输的效率也会受到影响。优先级帧可以独立于其他帧来设置流的优先级。同时，PRIORITY 帧也可以用于修改流的依赖关系，因此它具有比头帧更强的功能</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parsePriorityFrame</span><span class="params">(_ *frameCache, fh FrameHeader, payload []<span class="keyword">byte</span>)</span> <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, connError&#123;ErrCodeProtocol, <span class="string">"PRIORITY frame with stream ID 0"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(payload) != <span class="number">5</span> &#123;	<span class="comment">//负载必须是5</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, connError&#123;ErrCodeFrameSize, fmt.Sprintf(<span class="string">"PRIORITY frame payload size was %d; want 5"</span>, <span class="built_in">len</span>(payload))&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   v := binary.BigEndian.Uint32(payload[:<span class="number">4</span>])</span><br><span class="line">   streamID := v &amp; <span class="number">0x7fffffff</span> <span class="comment">// mask off high bit</span></span><br><span class="line">   <span class="keyword">return</span> &amp;PriorityFrame&#123;</span><br><span class="line">      FrameHeader: fh,</span><br><span class="line">      PriorityParam: PriorityParam&#123;</span><br><span class="line">         Weight:    payload[<span class="number">4</span>],		<span class="comment">//256</span></span><br><span class="line">         StreamDep: streamID,</span><br><span class="line">         Exclusive: streamID != v, <span class="comment">//是否是独立</span></span><br><span class="line">      &#125;,</span><br><span class="line">   &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>组成的优先级帧如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|           StreamDep(<span class="number">32</span>)						|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|Weight(<span class="number">8</span>)|</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>
<h5 id="framerststream"><a class="markdownIt-Anchor" href="#framerststream"></a> FrameRSTStream</h5>
<p>重置帧则只需要负载的前4个字节用于标志重置原因</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func parseRSTStreamFrame(_ *frameCache, fh FrameHeader, p []byte) (Frame, error) &#123;</span><br><span class="line">   if len(p) !&#x3D; 4 &#123;</span><br><span class="line">      return nil, ConnectionError(ErrCodeFrameSize)</span><br><span class="line">   &#125;</span><br><span class="line">   if fh.StreamID &#x3D;&#x3D; 0 &#123;</span><br><span class="line">      return nil, ConnectionError(ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   return &amp;RSTStreamFrame&#123;fh, ErrCode(binary.BigEndian.Uint32(p[:4]))&#125;, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析成如下结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            ErrCode(<span class="number">32</span>)			|</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure>
<p>组成的数据结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RSTStreamFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   ErrCode ErrCode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="framesettings"><a class="markdownIt-Anchor" href="#framesettings"></a> FrameSettings</h5>
<p>设置帧是通过 <code>parseSettingsFrame</code> 解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseSettingsFrame</span><span class="params">(_ *frameCache, fh FrameHeader, p []<span class="keyword">byte</span>)</span> <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> fh.Flags.Has(FlagSettingsAck) &amp;&amp; fh.Length &gt; <span class="number">0</span> &#123;	<span class="comment">//如果负载长度大于0，则肯定不是ACK帧</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeFrameSize)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID != <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(p)%<span class="number">6</span> != <span class="number">0</span> &#123;	<span class="comment">//设置帧固定是 6的倍数</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeFrameSize)</span><br><span class="line">   &#125;</span><br><span class="line">   f := &amp;SettingsFrame&#123;FrameHeader: fh, p: p&#125;	<span class="comment">//直接将负载存入设置帧中</span></span><br><span class="line">   <span class="keyword">if</span> v, ok := f.Value(SettingInitialWindowSize); ok &amp;&amp; v &gt; (<span class="number">1</span>&lt;&lt;<span class="number">31</span>)<span class="number">-1</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeFlowControl)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> f, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它因为直接使用了KV结构，所以固定每一对的长度是6，那么就能统计出每一对的内容</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *SettingsFrame)</span> <span class="title">Value</span><span class="params">(id SettingID)</span> <span class="params">(v <span class="keyword">uint32</span>, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">   f.checkValid()</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; f.NumSettings(); i++ &#123;</span><br><span class="line">      <span class="keyword">if</span> s := f.Setting(i); s.ID == id &#123;</span><br><span class="line">         <span class="keyword">return</span> s.Val, <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *SettingsFrame)</span> <span class="title">Setting</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">Setting</span></span> &#123;</span><br><span class="line">	buf := f.p</span><br><span class="line">	<span class="keyword">return</span> Setting&#123;</span><br><span class="line">		ID:  SettingID(binary.BigEndian.Uint16(buf[i*<span class="number">6</span> : i*<span class="number">6</span>+<span class="number">2</span>])),</span><br><span class="line">		Val: binary.BigEndian.Uint32(buf[i*<span class="number">6</span>+<span class="number">2</span> : i*<span class="number">6</span>+<span class="number">6</span>]),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一共存在6对</p>
<table>
<thead>
<tr>
<th>标志</th>
<th>说明</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>SettingHeaderTableSize</td>
<td>客户端和服务器通信时，指定用于HPACK头表大小的值</td>
<td>0x1</td>
</tr>
<tr>
<td>SettingEnablePush</td>
<td>服务器指示客户端是否可以推送资源</td>
<td>0x2</td>
</tr>
<tr>
<td>SettingMaxConcurrentStreams</td>
<td>指定客户端可以同时使用的最大流数</td>
<td>0x3</td>
</tr>
<tr>
<td>SettingInitialWindowSize</td>
<td>指定流控制窗口的初始大小</td>
<td>0x4</td>
</tr>
<tr>
<td>SettingMaxFrameSize</td>
<td>指定帧大小的最大值</td>
<td>0x5</td>
</tr>
<tr>
<td>SettingMaxHeaderListSize</td>
<td>指定头部列表大小的最大值</td>
<td>0x6</td>
</tr>
</tbody>
</table>
<p>所以对应的结构就是</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SettingsFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   p []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化窗口大小不能大于 <code>v &gt; (1&lt;&lt;31)-1</code></p>
<h5 id="framepushpromise"><a class="markdownIt-Anchor" href="#framepushpromise"></a> FramePushPromise</h5>
<p><code>FramePushPromise</code> 通过 <code>parsePushPromise</code> 进行数据解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parsePushPromise</span><span class="params">(_ *frameCache, fh FrameHeader, countError <span class="keyword">func</span>(<span class="keyword">string</span>)</span>, <span class="title">p</span> []<span class="title">byte</span>) <span class="params">(_ Frame, err error)</span></span> &#123;</span><br><span class="line">   pp := &amp;PushPromiseFrame&#123;</span><br><span class="line">      FrameHeader: fh,</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> pp.StreamID == <span class="number">0</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_pushpromise_zero_stream"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//如果有追加，那么就读取追加长度</span></span><br><span class="line">   <span class="keyword">var</span> padLength <span class="keyword">uint8</span></span><br><span class="line">   <span class="keyword">if</span> fh.Flags.Has(FlagPushPromisePadded) &#123;</span><br><span class="line">      <span class="keyword">if</span> p, padLength, err = readByte(p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">         countError(<span class="string">"frame_pushpromise_pad_short"</span>)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   p, pp.PromiseID, err = readUint32(p)	<span class="comment">//读取PromiseID </span></span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_pushpromise_promiseid_short"</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   pp.PromiseID = pp.PromiseID &amp; (<span class="number">1</span>&lt;&lt;<span class="number">31</span> - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">int</span>(padLength) &gt; <span class="built_in">len</span>(p) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   pp.headerFragBuf = p[:<span class="built_in">len</span>(p)-<span class="keyword">int</span>(padLength)]</span><br><span class="line">   <span class="keyword">return</span> pp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以二进制可以看出</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|           padLength(<span class="number">32</span>)			|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|			PromiseID(<span class="number">32</span>)			|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|				payload				|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|			  padding				|</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure>
<p>所以最后组成的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PushPromiseFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   PromiseID     <span class="keyword">uint32</span></span><br><span class="line">   headerFragBuf []<span class="keyword">byte</span> <span class="comment">// not owned</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="frameping"><a class="markdownIt-Anchor" href="#frameping"></a> FramePing</h5>
<p><code>FramePing</code> 通过 <code>parsePingFrame</code> 进行数据解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parsePingFrame</span><span class="params">(_ *frameCache, fh FrameHeader, countError <span class="keyword">func</span>(<span class="keyword">string</span>)</span>, <span class="title">payload</span> []<span class="title">byte</span>) <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(payload) != <span class="number">8</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_ping_length"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeFrameSize)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID != <span class="number">0</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_ping_has_stream"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   f := &amp;PingFrame&#123;FrameHeader: fh&#125;</span><br><span class="line">   <span class="built_in">copy</span>(f.Data[:], payload)</span><br><span class="line">   <span class="keyword">return</span> f, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>组成的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PingFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   Data [<span class="number">8</span>]<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ping帧中很特别的是负载是指定长度的8，通常是时间戳</p>
<h5 id="framegoaway"><a class="markdownIt-Anchor" href="#framegoaway"></a> FrameGoAway</h5>
<p><code>FrameGoAway</code> 通过 <code>parseGoAwayFrame</code> 进行数据解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseGoAwayFrame</span><span class="params">(_ *frameCache, fh FrameHeader, countError <span class="keyword">func</span>(<span class="keyword">string</span>)</span>, <span class="title">p</span> []<span class="title">byte</span>) <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID != <span class="number">0</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_goaway_has_stream"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(p) &lt; <span class="number">8</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_goaway_short"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeFrameSize)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> &amp;GoAwayFrame&#123;</span><br><span class="line">      FrameHeader:  fh,</span><br><span class="line">      LastStreamID: binary.BigEndian.Uint32(p[:<span class="number">4</span>]) &amp; (<span class="number">1</span>&lt;&lt;<span class="number">31</span> - <span class="number">1</span>),</span><br><span class="line">      ErrCode:      ErrCode(binary.BigEndian.Uint32(p[<span class="number">4</span>:<span class="number">8</span>])),</span><br><span class="line">      debugData:    p[<span class="number">8</span>:],</span><br><span class="line">   &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GoAway</code>帧用于通知对端，当前的连接即将关闭，以及关闭的原因。<code>LastStreamID</code> 表示这个流之后的所有流都将被关闭</p>
<p>组成的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GoAwayFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   LastStreamID <span class="keyword">uint32</span></span><br><span class="line">   ErrCode      ErrCode</span><br><span class="line">   debugData    []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="framewindowupdate"><a class="markdownIt-Anchor" href="#framewindowupdate"></a> FrameWindowUpdate</h5>
<p><code>FrameWindowUpdate</code> 通过 <code>parseWindowUpdateFrame</code> 进行数据解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseWindowUpdateFrame</span><span class="params">(_ *frameCache, fh FrameHeader, countError <span class="keyword">func</span>(<span class="keyword">string</span>)</span>, <span class="title">p</span> []<span class="title">byte</span>) <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(p) != <span class="number">4</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_windowupdate_bad_len"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeFrameSize)</span><br><span class="line">   &#125;</span><br><span class="line">   inc := binary.BigEndian.Uint32(p[:<span class="number">4</span>]) &amp; <span class="number">0x7fffffff</span> <span class="comment">// mask off high reserved bit</span></span><br><span class="line">   <span class="keyword">if</span> inc == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> fh.StreamID == <span class="number">0</span> &#123;</span><br><span class="line">         countError(<span class="string">"frame_windowupdate_zero_inc_conn"</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nil</span>, ConnectionError(ErrCodeProtocol)</span><br><span class="line">      &#125;</span><br><span class="line">      countError(<span class="string">"frame_windowupdate_zero_inc_stream"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, streamError(fh.StreamID, ErrCodeProtocol)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> &amp;WindowUpdateFrame&#123;</span><br><span class="line">      FrameHeader: fh,</span><br><span class="line">      Increment:   inc,</span><br><span class="line">   &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>组成的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WindowUpdateFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   Increment <span class="keyword">uint32</span> <span class="comment">// never read with high bit set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="framecontinuation"><a class="markdownIt-Anchor" href="#framecontinuation"></a> FrameContinuation</h5>
<p><code>FrameContinuation</code> 通过 <code>parseContinuationFrame</code> 进行数据解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseContinuationFrame</span><span class="params">(_ *frameCache, fh FrameHeader, countError <span class="keyword">func</span>(<span class="keyword">string</span>)</span>, <span class="title">p</span> []<span class="title">byte</span>) <span class="params">(Frame, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> fh.StreamID == <span class="number">0</span> &#123;</span><br><span class="line">      countError(<span class="string">"frame_continuation_zero_stream"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, connError&#123;ErrCodeProtocol, <span class="string">"CONTINUATION frame with stream ID 0"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> &amp;ContinuationFrame&#123;fh, p&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>组成的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ContinuationFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   FrameHeader</span><br><span class="line">   headerFragBuf []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个将用在帧过大的时候进行数据分帧，这个逻辑将在下面的分帧逻辑进行进一步分析</p>
<h3 id="应用帧"><a class="markdownIt-Anchor" href="#应用帧"></a> 应用帧</h3>
<p>上面其实看的是HTTP2协议中的协议帧，而实际在grpc-go中又做了进一步的区分</p>
<table>
<thead>
<tr>
<th>帧类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>incomingWindowUpdate</td>
<td>通知发送方更新发送窗口的大小</td>
</tr>
<tr>
<td>outgoingWindowUpdate</td>
<td>通知接收方更新接收窗口的大小</td>
</tr>
<tr>
<td>incomingSettings</td>
<td>设置帧</td>
</tr>
<tr>
<td>outgoingSettings</td>
<td>设置帧</td>
</tr>
<tr>
<td>headerFrame</td>
<td>帧的头部信息</td>
</tr>
<tr>
<td>registerStream</td>
<td>服务器专用</td>
</tr>
<tr>
<td>cleanupStream</td>
<td>针对RST帧</td>
</tr>
<tr>
<td>earlyAbortStream</td>
<td></td>
</tr>
<tr>
<td>incomingGoAway</td>
<td>为客户端服务，客户端一旦接受此帧，帧发送器状态为draining</td>
</tr>
<tr>
<td>dataFrame</td>
<td>数据帧</td>
</tr>
<tr>
<td>ping</td>
<td>Ping帧</td>
</tr>
<tr>
<td>goAway</td>
<td>goAway帧</td>
</tr>
<tr>
<td>outFlowControlSizeRequest</td>
<td></td>
</tr>
</tbody>
</table>
<p>这里特殊说明一个数据帧，因为在后续的分帧会说到</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> dataFrame <span class="keyword">struct</span> &#123;</span><br><span class="line">   streamID  <span class="keyword">uint32</span>				<span class="comment">//帧所属的流</span></span><br><span class="line">   endStream <span class="keyword">bool</span>					<span class="comment">//该帧是否为该流的最后一帧</span></span><br><span class="line">   h         []<span class="keyword">byte</span>				<span class="comment">//帧的头部，包含了一些控制信息，例如帧长度、类型、标志等</span></span><br><span class="line">   d         []<span class="keyword">byte</span>				<span class="comment">//帧的数据负载</span></span><br><span class="line">   onEachWrite <span class="function"><span class="keyword">func</span><span class="params">()</span>			//在每次写出帧的一部分数据时调用的回调函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>特殊注意的就是<code>d</code> 字段，表示的数据负载在传输时可能被切割成多个 <code>dataFrame</code> 进行传输。</p>
<h3 id="分帧"><a class="markdownIt-Anchor" href="#分帧"></a> 分帧</h3>
<p>当数据过大时，就需要分批发送</p>
<blockquote>
<p>TCP 分段(segment):将应用层数据分成多个 TCP 段进行传输，每个 TCP 段都有自己的头部信息</p>
<p>应用层 分包(packet)：分包是指将一个应用层数据包分成多个 IP 数据报进行传输</p>
<p>IP数据包 分片(fragmentation)：分片是指将一个 IP 数据报分成多个较小的数据报进行传输</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/f3f3f45e713842cdb0162ae119b6045f.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTE1ODI5MjI=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" /></p>
<p>将发送的请求Body超过限制16KB就能看到分帧了</p>
<img src="https://images-1307117474.cos.ap-guangzhou.myqcloud.com/blogs/Blog_3/http2_dataframe2.png" alt="http2_dataframe2" style="zoom:50%;" />
<p>抓包可以看到其实单个帧的大小是 16384，而他们两个区别是</p>
<ol>
<li>在第二个中间带上的是<code>0x01 EndStream</code>，表示这个流结束</li>
<li>因为负载不同，所以他们头部<code>Length</code>也不一样，但是最大就是16384</li>
</ol>
<p>然后直接看看分帧分别是如何发送与接收的</p>
<h4 id="客户端"><a class="markdownIt-Anchor" href="#客户端"></a> 客户端</h4>
<p>接着上述 dataFrame的结构说起，它并不是直接切分成多个，而是一部分一部分的切割发送</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *http2Client)</span> <span class="title">Write</span><span class="params">(s *Stream, hdr []<span class="keyword">byte</span>, data []<span class="keyword">byte</span>, opts *Options)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	df := &amp;dataFrame&#123;</span><br><span class="line">		streamID:  s.id,</span><br><span class="line">		endStream: opts.Last,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> hdr != <span class="literal">nil</span> || data != <span class="literal">nil</span> &#123; <span class="comment">// If it's not an empty data frame.</span></span><br><span class="line">		<span class="comment">// Add some data to grpc message header so that we can equally</span></span><br><span class="line">		<span class="comment">// distribute bytes across frames.</span></span><br><span class="line">		emptyLen := http2MaxFrameLen - <span class="built_in">len</span>(hdr)</span><br><span class="line">		<span class="keyword">if</span> emptyLen &gt; <span class="built_in">len</span>(data) &#123;</span><br><span class="line">			emptyLen = <span class="built_in">len</span>(data)</span><br><span class="line">		&#125;</span><br><span class="line">		hdr = <span class="built_in">append</span>(hdr, data[:emptyLen]...)</span><br><span class="line">		data = data[emptyLen:]</span><br><span class="line">		df.h, df.d = hdr, data</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t.controlBuf.put(df)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析如下：</p>
<ol>
<li><code>hdr</code> 是应用层grpc帧的头 长度为 5B(1B是否压缩 + 4B负载长度)</li>
<li>data 是应用层grpc帧的负载数据</li>
<li>构建步骤如下：
<ol>
<li>首先构建一个数据帧(应用层的)，指定流ID以及是否是最后一个流(<code>!cs.desc.ClientStreams</code>)</li>
<li>然后判断数据是否超过http2MaxFrameLen(16384)</li>
<li>接着 **从data中截取一部分放入到 数据帧的<code>h</code>，然后将剩余部分放入到d中！！！！！**所以这里的<code>h</code>与<code>d</code>并不是指的头与负载</li>
<li>最后将整个帧放入到帧缓冲器中</li>
</ol>
</li>
</ol>
<p>经过获取帧并将帧放入到链表之后到数据帧的处理中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *loopyWriter)</span> <span class="title">processData</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	 <span class="comment">//...</span></span><br><span class="line">   dataItem := str.itl.peek().(*dataFrame) <span class="comment">//头部数据帧的指针，并不是出栈</span></span><br><span class="line">	<span class="comment">//如果数据帧是空的，那么直接发送结束帧并关闭流</span></span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(dataItem.h) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(dataItem.d) == <span class="number">0</span> &#123; <span class="comment">// Empty data frame</span></span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">      idx <span class="keyword">int</span></span><br><span class="line">      buf []<span class="keyword">byte</span></span><br><span class="line">   )</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(dataItem.h) != <span class="number">0</span> &#123; <span class="comment">// data header has not been written out yet.</span></span><br><span class="line">      buf = dataItem.h</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      idx = <span class="number">1</span></span><br><span class="line">      buf = dataItem.d</span><br><span class="line">   &#125;</span><br><span class="line">   size := http2MaxFrameLen</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(buf) &lt; size &#123;</span><br><span class="line">      size = <span class="built_in">len</span>(buf)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//... 流级别与连接级别流控</span></span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line">   <span class="comment">//发送最大帧以及流控控制下的size</span></span><br><span class="line">   <span class="keyword">if</span> err := l.framer.fr.WriteData(dataItem.streamID, endStream, buf[:size]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">   &#125;</span><br><span class="line">   buf = buf[size:]	<span class="comment">//更新剩余部分</span></span><br><span class="line">   <span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">      dataItem.h = buf</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dataItem.d = buf</span><br><span class="line">   &#125;</span><br><span class="line">		</span><br><span class="line">   <span class="comment">//如果消息发完那么流头部消息发送完毕，则退出该消息</span></span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(dataItem.h) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(dataItem.d) == <span class="number">0</span> &#123; <span class="comment">// All the data from that message was written out.</span></span><br><span class="line">      str.itl.dequeue()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相当于整个数据一次性放入到流的消息链表中，然后每次从数据中截取一部分给HTTP2进行发送</p>
<h4 id="服务端"><a class="markdownIt-Anchor" href="#服务端"></a> 服务端</h4>
<p>服务端则是从结束数据开始看</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *parser)</span> <span class="title">recvMsg</span><span class="params">(maxReceiveMessageSize <span class="keyword">int</span>)</span> <span class="params">(pf payloadFormat, msg []<span class="keyword">byte</span>, err error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">if</span> _, err := p.r.Read(p.header[:]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span>, err</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pf = payloadFormat(p.header[<span class="number">0</span>])</span><br><span class="line">   length := binary.BigEndian.Uint32(p.header[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">   <span class="comment">//...负载长度判断</span></span><br><span class="line">   <span class="keyword">if</span> _, err := p.r.Read(msg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">         err = io.ErrUnexpectedEOF</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span>, err</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> pf, msg, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先直接读取头部长度</li>
<li>接着校验负载长度是否异常(不能超过 接收最大长度)</li>
<li>接着读取指定长度</li>
</ul>
<p>到这里其实消息体已经是完整的应用层数据帧了，接着我们看下这个应用层数据帧是如何缓存的以及怎样触发读取的</p>
<p>分帧得从</p>
<p>由于流使用的是多路复用，所以每个流需要使用缓冲保存分帧数据，当判断已经获取到完整的帧的时候，再从缓冲中获取数据即可。这里用到的结构是 <code>recvBuffer</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> recvBuffer <span class="keyword">struct</span> &#123;</span><br><span class="line">   c       <span class="keyword">chan</span> recvMsg		<span class="comment">//make(chan recvMsg, 1)</span></span><br><span class="line">   mu      sync.Mutex</span><br><span class="line">   backlog []recvMsg</span><br><span class="line">   err     error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取到数据帧之后，会将帧存入到 <code>recvBuffer</code> 中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Stream)</span> <span class="title">write</span><span class="params">(m recvMsg)</span></span> &#123;</span><br><span class="line">   s.buf.put(m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后这里做了一个特殊的设计</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *recvBuffer)</span> <span class="title">put</span><span class="params">(r recvMsg)</span></span> &#123;</span><br><span class="line">   b.mu.Lock()</span><br><span class="line">   <span class="keyword">if</span> b.err != <span class="literal">nil</span> &#123;</span><br><span class="line">      b.mu.Unlock()</span><br><span class="line">      <span class="comment">// An error had occurred earlier, don't accept more</span></span><br><span class="line">      <span class="comment">// data or errors.</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   b.err = r.err</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(b.backlog) == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> b.c &lt;- r:</span><br><span class="line">         b.mu.Unlock()</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   b.backlog = <span class="built_in">append</span>(b.backlog, r)</span><br><span class="line">   b.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个操作</p>
<ol>
<li>当 backlog 为空，则直接写入到隧道中</li>
<li>当 backlog 不为空，则追加到backlog后面</li>
</ol>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<ol>
<li>帧分为帧头与负载，帧头长度为9</li>
<li>帧类型为10种，并结合flags进行使用</li>
</ol>
<h3 id="参考文档"><a class="markdownIt-Anchor" href="#参考文档"></a> 参考文档</h3>
<ol>
<li><a href="https://blog.csdn.net/u011582922/article/details/120578941" target="_blank" rel="noopener">https://blog.csdn.net/u011582922/article/details/120578941</a></li>
<li><a href="https://www.jianshu.com/p/e22fef60a7f0" target="_blank" rel="noopener">https://www.jianshu.com/p/e22fef60a7f0</a></li>
</ol>

      
    </div>
    <div class="article-footer">
      <!--
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://xboom.github.io/2022/10/11/Grpc/Grpc-05-%E5%B8%A7/" title="Grpc-03-帧" target="_blank" rel="external">http://xboom.github.io/2022/10/11/Grpc/Grpc-05-帧/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/XBoom" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/XBoom" target="_blank"><span class="text-dark">Yuan Kang</span><small class="ml-1x">Learn and live</small></a></h3>
        <div>Talk is cheap, Show me your code</div>
      </div>
    </figure>
  </div>
</div>


      -->
    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/10/13/Grpc/Grpc-06-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" title="Grpc-06-多路复用"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2022/10/09/Grpc/Grpc-04-%E5%B8%A7%E6%8E%A5%E6%94%B6%E5%99%A8/" title="Grpc-04-帧接收器"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="Catalogue" role="button">    <span>[&nbsp;</span><span>Catalogue</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/XBoom" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=728081687@qq.com" target="_blank" title="Email" data-toggle=tooltip data-placement=top><i class="icon icon-email"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <!--
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
        -->
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   


<!-- custom analytics part create by xiamo -->
<script defer src="https://cdn1.lncld.net/static/js/av-min-1.2.1.js"></script>
<script defer>
AV.init({
  appId: 'SbGHqy6xigse8A1P9rctla9N-gzGzoHsz',
  appKey: 'Yjv3BxtjwA5IStDccnVj1eQr'
});

function showTime(Counter) {
	var query = new AV.Query(Counter);
		var visitors= $('.leancloud_visitors');
		query.greaterThanOrEqualTo("time", 0);		
		query.find({
			success: function(results) {
				if (results.length == 0) {				
					return;
				}
				var data = results;
				visitors.each(function(){
					var url = $(this).attr('id').trim();					
					for (var i = 0; i < data.length; i++) {
						var object = data[i];
						var content = object.get('time');
						var _url = object.get('url')
						if(url == _url){
							$(this).text(content);
						}
					}
				})
				
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content = counter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = newcounter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else {
		showTime(Counter);
	}
}); 
</script>



   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: 'SbGHqy6xigse8A1P9rctla9N-gzGzoHsz',
    appKey: 'Yjv3BxtjwA5IStDccnVj1eQr',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     






    <script defer>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?35ec0b872cf5aada9525fd9f0487c238";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>



</body>
</html>